# 笔记

lerna 版本 6.4.1

- [笔记](#笔记)
  - [固定模式 vs 独立模式](#固定模式-vs-独立模式)
  - [命令](#命令)
    - [lerna init --independent](#lerna-init---independent)
    - [lerna bootstrap](#lerna-bootstrap)
    - [lerna bootstrap --hoist](#lerna-bootstrap---hoist)
    - [lerna add](#lerna-add)
    - [lerna clean](#lerna-clean)
  - [lerna.json](#lernajson)
  - [yarn workspaces](#yarn-workspaces)

>资料一：[Lerna学习与理解](https://juejin.cn/post/7005399626744332295)  
>资料二：[Yarn Workspace使用指南](https://juejin.cn/post/6974967455114362888)  

## 固定模式 vs 独立模式

**固定模式：**版本号使用项目根目录下lerna.json文件中的version属性。执行lerna publish时，如果代码有更新，会自动更新此版本号的值，其他有改动子包也自动更新版本号，没改动的子包不更新版本号。也就是所有包的版本号都跟根目录下lerna.json文件中的version是有关系的。Babel库是用的这种模式。
**独立模式：**子包们的版本号独自维护，和根目录的配置没关系。每次publish时，得为每个更改的子包设置版本。

## 命令

### lerna init --independent

用独立模式初始化

### lerna bootstrap

执行lerna bootstrap相当于为packages下所有子项目都npm install了一下

### lerna bootstrap --hoist

依赖包都安装在了根目录文件夹下的node_modules，而子包里都没有node_modules，统一管理依赖

>

**注意** 高版本直接使用 lerna bootstrap，v7会废弃

### lerna add

为所有的子包添加依赖，如果子包已经有了该依赖会被覆盖调，使用lerna add package --scope=package.name，指定子包安装

### lerna clean

清空子包中的node_modules

## lerna.json

```json
{
  "version": "independent",
  "packages": ["packages/*", "examples/*"],
  "npmClient": "yarn", // 使用yarn安装依赖
  "useWorkspaces": true, // 使用yarn workspaces
  "command": {
    "version": {
      "allowBranch": "master",
      "includeMergedTags": true
    },
    "publish": {
      "message": "chore(release): publish",
      "registry": "https://registry.npmjs.org/" // 发布地址
    }
  },
  // 这些文件更改，不需升级版本。
  "ignoreChanges": [
    "ignored-file",
    "**/__tests__/**",
    "**/*.md"
  ]
}
```

## yarn workspaces

yarn 版本 1.22.18

- 使用 workspaces 无论在子包还是根目录install，相同的依赖会提升到根目录
- 使用install子包和根目录的node_modules都会重新安装
- 根目录的依赖和子包的依赖版本不一样，子包的依赖不会提升
- 本地的包只要被应用了，会在根目录创建一个软连接
- 只会在根目录生成一个yarn.lock文件
- 使用workspaces，private必须为true
- 根目录的本地依赖名称来自于，子包package.json的name字段
- 根目录的node_modules会直接子包的软连接
- a包依赖的b包的版本和本地的包版本不一样，会直接拉取远程的
- 安装移除依赖包都会重新install
